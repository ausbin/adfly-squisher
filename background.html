<html>
<!--
    background.html - Runs in the background and replaces links
    Copyright (C) 2011 Austin Adams

    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation; either version 2 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License along
    with this program; if not, write to the Free Software Foundation, Inc.,
    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
-->
<head>
<script type="text/javascript" src="global.js"></script>
<script>
    function grindRegexes (regexes) {
        var result = [];

        for (var i = 0; i < regexes.length; i++) {
            result.push("^" + regexes[i] + "$");
        }

        return result;
    }

    function prepProxy (proxy) {
        return proxy.replace("%s", "$$2");
    }

    function squishFlies (id, proxy) {
      chrome.tabs.executeScript(
          id, {code:"document.body.innerHTML = document.body.innerHTML.replace(/(http:\\/\\/)?adf.ly\\/([A-Za-z0-9]{5})/g, '" + proxy + "')"}
      );
    }

    // Called when the user clicks on the browser action.
    chrome.browserAction.onClicked.addListener(function () {squishFlies(null, prepProxy(getPrefs()["proxy"]))});

    chrome.tabs.onUpdated.addListener(function (id, info, tab) {
        if (info.status == "complete") {
            var prefs = getPrefs();
            var regexes = grindRegexes(prefs["regexes"]);

            for (var i = 0; i < regexes.length; i++) {
                try {
                    var r = RegExp(regexes[i]);
                } catch (SyntaxError) {
                    console.error("URL Regex number " + i + " is invalid!");
                    continue;
                }

                if (r.test(tab.url)) {
                    squishFlies(id, prepProxy(prefs["proxy"]));
                    break;
                }
            }
        }
    });
    
    //chrome.tabs.onCreated.addListener(function (tab) {
    //
    //    console.log(tab);
    //    //chrome.tabs.update(tab.id, {url:"http://thesupremenerd.com"});
    //});
</script>
</head>
</html>
